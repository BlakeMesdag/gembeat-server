require 'test_helper'

class VulnerabilityTest < ActiveSupport::TestCase
  def setup
    @vulnerability = vulnerabilities(:rails)
    @vulnerability_params = {
      dependency_name: "json", 
      identifier: "CVE-1234-567",
      url: "http://someurl.com/CVE-1234-567",
      description: "A vulnerability in json",
      versions: ["1.7.7", "1.6.5"]
    }
  end

  test "vulnerability needs a dependency_name" do
    @vulnerability_params.delete(:dependency_name)

    assert_difference "Vulnerability.count", 0 do
      Vulnerability.create(@vulnerability_params)
    end
  end

  test "assess_dependency returns true if a dependency is vulnerable" do
    @vulnerability.versions = ["3.2.13", "3.1.10"]

    dependency = dependencies(:gembeat_dependency)

    assert_equal true, @vulnerability.assess_dependency(dependency)
  end

  test "assess_dependency returns false if a minor dependency version isn't listed in the vulnerability" do
    @vulnerability.versions = ["3.0.17"]

    dependency = dependencies(:gembeat_dependency)

    assert_equal false, @vulnerability.assess_dependency(dependency)
  end

  test "assess_dependency returns false if a dependency version is equal to a version listed in the vulnerability" do
    @vulnerability.versions = ["3.2.12"]

    dependency = dependencies(:gembeat_dependency)

    assert_equal false, @vulnerability.assess_dependency(dependency)
  end
end
